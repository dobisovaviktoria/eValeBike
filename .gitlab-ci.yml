services:
  - docker:20.10.24-dind

include:
  - template: Security/SAST.gitlab-ci.yml

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEYY
  APP_SERVER: $APP_SERVER
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_REF_SLUG
  DOCKERHUB_USER: $DOCKERHUB_USERNAME
  DOCKERHUB_PASS: $DOCKERHUB_PASSWORD

stages:
  - build
  - test
  - sast
  - deploy
  - destroy

before_script:
  - echo "Starting CI/CD pipeline..."

build_job:
  stage: build
  image: gradle:8.4.0-jdk21
  tags:
    - docker
    - gradle
    - java
  variables:
    SPRING_DATASOURCE_URL: jdbc:sqlserver://evalebike.database.windows.net:1433;database=eValeBike;user=user@evalebike;password=password!1;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30
    SPRING_DATASOURCE_USERNAME: user
    SPRING_DATASOURCE_PASSWORD: password!1
  script:
    - gradle build -x test
  artifacts:
    paths:
      - build/libs/*.jar
      - build/libs/
    expire_in: 1 week

test_job:
  stage: test
  image: gradle:8.4.0-jdk21
  tags:
    - docker
    - gradle
    - java
  variables:
    SPRING_DATASOURCE_URL: jdbc:sqlserver://evalebike.database.windows.net:1433;database=eValeBikeTest;user=user@evalebike;password=password!1;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30
    SPRING_DATASOURCE_USERNAME: user
    SPRING_DATASOURCE_PASSWORD: password!1
  services:
    - name: docker:20.10.24-dind
      alias: docker
  before_script:
    - echo "Installing connectivity tools..."
    - apt-get update && apt-get install -y telnet netcat-openbsd || echo "Failed to install tools, continuing..."
    - echo "Testing Azure SQL connectivity..."
    - telnet evalebike.database.windows.net 1433 || echo "Telnet to Azure SQL failed"
    - nc -zv evalebike.database.windows.net 1433 || echo "Netcat to Azure SQL failed"
  script:
    - echo "Checking Docker service..."
    - docker info || echo "Docker info failed, continuing..."
    - echo "Running tests..."
    - gradle test --info
    - echo "Listing test results directory..."
    - ls -la build/test-results/test/
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/test/
  needs:
    - build_job

sast:
  stage: sast
  script:
    - echo "Running SAST analysis..."
  artifacts:
    paths:
      - gl-sast-report.json
    expire_in: 1 week
  allow_failure: false

deploy_job:
  stage: deploy
  image: docker:stable
  services:
    - name: docker:20.10.24-dind
      alias: docker
  tags:
    - docker
  before_script:
    - echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEYY" | base64 -d > ~/.ssh/gitlabrunner
    - chmod 600 ~/.ssh/gitlabrunner
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/gitlabrunner
    - ssh-keyscan -H $APP_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "$IMAGE_NAME:$IMAGE_TAG"
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - |
      ssh -tt team4@$APP_SERVER << EOF
        sudo docker stop spring-app || true
        sudo docker rm spring-app || true
        sudo docker pull $IMAGE_NAME:$IMAGE_TAG
        sudo docker run -d --name spring-app -p 80:8080 -e SPRING_DATASOURCE_URL="$SPRING_DATASOURCE_URL" -e SPRING_DATASOURCE_USERNAME="$SPRING_DATASOURCE_USERNAME" -e SPRING_DATASOURCE_PASSWORD="$SPRING_DATASOURCE_PASSWORD" $IMAGE_NAME:$IMAGE_TAG
        exit
      EOF

destroy_job:
  stage: destroy
  when: manual
  image: docker:stable
  services:
    - name: docker:20.10.24-dind
      alias: docker
  tags:
    - docker
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEYY" | base64 -d > ~/.ssh/gitlabrunner
    - chmod 600 ~/.ssh/gitlabrunner
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/gitlabrunner
    - ssh-keyscan -H $APP_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Stopping and removing the container..."
    - |
      ssh -tt team4@$APP_SERVER << EOF
        sudo docker stop spring-app || true
        sudo docker rm spring-app || true
        exit
      EOF